### Test for upstream-response-transformer plugin

### 1. Create a route with upstream-response-transformer plugin (notify mode)
POST http://localhost:9180/apisix/admin/routes/1
X-API-KEY: edd1c9f034335f136f87ad84b625c8f1
Content-Type: application/json

{
  "uri": "/test-upstream-response-notify",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "httpbin.org:80": 1
    }
  },
  "plugins": {
    "upstream-response-transformer": {
      "external_api_url": "https://httpbin.org/anything",
      "timeout": 10000,
      "forward_headers": ["User-Agent", "X-Custom-Header"],
      "method": "POST",
      "mode": "notify",
      "response_headers": [
        {
          "name": "X-External-API-Status",
          "mode": "replace",
          "success_value": "success",
          "failure_value": "failed"
        },
        {
          "name": "X-Notify-Header",
          "mode": "notify",
          "success_value": "notified"
        }
      ]
    }
  }
}

### 2. Test the notify mode route (response should remain unchanged, external API called)
GET http://localhost:9000/test-upstream-response-notify/get
User-Agent: TestClient/1.0
X-Custom-Header: test-value

### 3. Create a route with upstream-response-transformer plugin (replace mode)
POST http://localhost:9180/apisix/admin/routes/2
X-API-KEY: edd1c9f034335f136f87ad84b625c8f1
Content-Type: application/json

{
  "uri": "/test-upstream-response-replace",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "httpbin.org:80": 1
    }
  },
  "plugins": {
    "upstream-response-transformer": {
      "external_api_url": "https://httpbin.org/anything",
      "timeout": 10000,
      "forward_headers": ["User-Agent", "X-Custom-Header"],
      "method": "POST",
      "mode": "replace",
      "response_headers": [
        {
          "name": "X-Response-Modified",
          "mode": "replace",
          "success_value": "true",
          "failure_value": "false"
        }
      ]
    }
  }
}

### 4. Test the replace mode route (response should be replaced with external API response)
GET http://localhost:9000/test-upstream-response-replace/get
User-Agent: TestClient/1.0
X-Custom-Header: test-value

### 5. Create a route with a failing external API (to test failure handling)
POST http://localhost:9180/apisix/admin/routes/3
X-API-KEY: edd1c9f034335f136f87ad84b625c8f1
Content-Type: application/json

{
  "uri": "/test-upstream-response-fail",
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "httpbin.org:80": 1
    }
  },
  "plugins": {
    "upstream-response-transformer": {
      "external_api_url": "https://httpbin.org/status/500",
      "timeout": 5000,
      "method": "POST",
      "mode": "replace",
      "response_headers": [
        {
          "name": "X-External-API-Status",
          "mode": "replace",
          "success_value": "success",
          "failure_value": "failed"
        },
        {
          "name": "X-Error-Header",
          "mode": "empty",
          "failure_value": "external-api-error"
        }
      ]
    }
  }
}

### 6. Test the failing external API route (should keep original response and set failure headers)
GET http://localhost:9000/test-upstream-response-fail/get

### 7. Delete test routes
DELETE http://localhost:9180/apisix/admin/routes/1
X-API-KEY: edd1c9f034335f136f87ad84b625c8f1

###
DELETE http://localhost:9180/apisix/admin/routes/2
X-API-KEY: edd1c9f034335f136f87ad84b625c8f1

###
DELETE http://localhost:9180/apisix/admin/routes/3
X-API-KEY: edd1c9f034335f136f87ad84b625c8f1 